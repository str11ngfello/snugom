use anyhow::{Context, Result};
use clap::Args;
use std::fs;
use std::path::Path;

use crate::context::{ProjectContext, SnugomConfig};
use crate::examples::ExampleGroup;
use crate::output::OutputManager;
use crate::theme::ICONS;

pub const EXAMPLES: &[ExampleGroup] = &[ExampleGroup {
    title: "Initialize SnugOM",
    commands: &[
        "snugom init              # Initialize in current project",
        "snugom init --force      # Reinitialize, overwriting config",
    ],
}];

#[derive(Args)]
pub struct InitArgs {
    /// Overwrite existing configuration
    #[arg(long)]
    pub force: bool,
}

pub async fn handle_init(
    args: InitArgs,
    output: &OutputManager,
) -> Result<()> {
    initialize_project(args.force, output).await
}

async fn initialize_project(force: bool, output: &OutputManager) -> Result<()> {
    output.progress("Finding project root");

    let ctx = ProjectContext::find()?;

    output.clear_line();

    if ctx.is_initialized() && !force {
        output.warning("SnugOM is already initialized in this project.");
        output.info("Use --force to reinitialize.");
        return Ok(());
    }

    output.heading("Initializing SnugOM");

    // Create .snugom directory
    create_dir_if_needed(&ctx.snugom_dir, output)?;

    // Create schemas directory
    create_dir_if_needed(&ctx.schemas_dir, output)?;

    // Create config.toml
    create_config_file(&ctx.config_path, output)?;

    // Create migrations directory and mod.rs
    create_migrations_module(&ctx.migrations_dir, output)?;

    output.success("SnugOM initialized successfully!");

    println!();
    output.info("Next steps:");
    output.bullet("Add #[derive(SnugomEntity)] to your entity structs");
    output.bullet("Run 'snugom migrate --name init' to create your first migration");

    Ok(())
}

fn create_dir_if_needed(path: &Path, output: &OutputManager) -> Result<()> {
    if !path.exists() {
        fs::create_dir_all(path)
            .with_context(|| format!("Failed to create directory: {path:?}"))?;
        output.indented(
            ICONS.folder,
            &format!("Created {}", path.display()),
        );
    }
    Ok(())
}

fn create_config_file(path: &Path, output: &OutputManager) -> Result<()> {
    let config = SnugomConfig::default();
    let content = toml::to_string_pretty(&config).context("Failed to serialize config")?;

    fs::write(path, content).with_context(|| format!("Failed to write config: {path:?}"))?;

    output.indented(ICONS.file, &format!("Created {}", path.display()));
    Ok(())
}

fn create_migrations_module(migrations_dir: &Path, output: &OutputManager) -> Result<()> {
    create_dir_if_needed(migrations_dir, output)?;

    let mod_path = migrations_dir.join("mod.rs");

    if !mod_path.exists() {
        let content = r#"//! Auto-generated by snugom. Migrations are added here automatically.

use snugom::migration::MigrationRegistry;

pub fn register_all(registry: &mut MigrationRegistry) {
    // Migrations will be registered here
}
"#;

        fs::write(&mod_path, content)
            .with_context(|| format!("Failed to write migrations mod.rs: {mod_path:?}"))?;

        output.indented(ICONS.file, &format!("Created {}", mod_path.display()));
    }

    Ok(())
}
